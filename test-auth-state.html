<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth State Debug | Laiq Bags</title>
    <link href="/css/styles.css" rel="stylesheet">
    <style>
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .status-admin { background-color: #d1fae5; border-color: #10b981; }
        .status-customer { background-color: #dbeafe; border-color: #3b82f6; }
        .status-none { background-color: #fef3c7; border-color: #f59e0b; }
        .error { background-color: #fee2e2; border-color: #ef4444; }
        .success { background-color: #dcfce7; border-color: #22c55e; }
    </style>
</head>
<body class="bg-beige min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">üîç Authentication State Debug</h1>
        
        <div class="debug-section">
            <h2 class="text-xl font-semibold mb-4">Current Authentication Status</h2>
            <div id="auth-status" class="text-lg"></div>
        </div>
        
        <div class="debug-section">
            <h2 class="text-xl font-semibold mb-4">Local Storage Contents</h2>
            <div id="storage-contents" class="font-mono text-sm"></div>
        </div>
        
        <div class="debug-section">
            <h2 class="text-xl font-semibold mb-4">Actions</h2>
            <div class="space-y-4">
                <button onclick="debugAuthState()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    üîç Debug Auth State
                </button>
                <button onclick="runAuthFix()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    üîß Run Auth Fix
                </button>
                <button onclick="runComprehensiveFix()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">
                    üöÄ Run Comprehensive Fix
                </button>
                <button onclick="clearAllAuth()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    üßπ Clear All Auth
                </button>
                <button onclick="testContextSwitch()" class="bg-green-500 text-white px-4 py-4 rounded hover:bg-green-600">
                    üîÑ Test Context Switch
                </button>
                <button onclick="testCartLoading()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                    üõí Test Cart Loading
                </button>
                <button onclick="refreshPage()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    üîÑ Refresh Page
                </button>
                <button onclick="checkScriptsLoaded()" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                    üîç Check Scripts
                </button>
            </div>
        </div>
        
        <div class="debug-section">
            <h2 class="text-xl font-semibold mb-4">Console Logs</h2>
            <div id="console-logs" class="bg-black text-green-400 p-4 rounded font-mono text-sm h-64 overflow-y-auto"></div>
        </div>
    </div>

    <script src="/js/auth-switcher.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/api.js"></script>
    <script src="/fix-auth-cart-issues.js"></script>
    <script>
        // Global variables to track script loading
        window.scriptsLoaded = {
            authSwitcher: false,
            main: false,
            api: false,
            fixScript: false
        };
        
        // Add missing functions directly to ensure they're available
        if (typeof window.loadUserCart === 'undefined') {
            window.loadUserCart = function() {
                try {
                    const userCartData = localStorage.getItem('userCart');
                    if (userCartData) {
                        try {
                            const userCart = JSON.parse(userCartData);
                            console.log('üì• Loaded user cart from localStorage:', userCart.length, 'items');
                            
                            // Normalize data structure
                            return userCart.map(item => ({
                                id: item.id || item.productId || 'unknown',
                                productId: item.productId || item.id || 'unknown',
                                name: item.name || 'Unknown Product',
                                price: parseFloat(item.price) || 0,
                                image: item.image || 'https://via.placeholder.com/56x56?text=Product',
                                qty: parseInt(item.qty) || parseInt(item.quantity) || 1,
                                color: item.color || null,
                            }));
                        } catch (parseError) {
                            console.error('‚ùå Error parsing user cart from localStorage:', parseError);
                            return [];
                        }
                    }
                    return [];
                } catch (error) {
                    console.error('‚ùå Error loading user cart:', error);
                    return [];
                }
            };
            console.log('‚úÖ loadUserCart function added directly to test page');
        }
        
        if (typeof window.loadGuestCart === 'undefined') {
            window.loadGuestCart = function() {
                try {
                    const guestCartData = localStorage.getItem('guestCart');
                    if (guestCartData) {
                        try {
                            const guestCart = JSON.parse(guestCartData);
                            console.log('üì• Loaded guest cart from localStorage:', guestCart.length, 'items');
                            return guestCart;
                        } catch (e) {
                            console.error('‚ùå Error parsing guest cart:', e);
                            return [];
                        }
                    }
                    return [];
                } catch (error) {
                    console.error('‚ùå Error loading guest cart:', error);
                    return [];
                }
            };
            console.log('‚úÖ loadGuestCart function added directly to test page');
        }
        
        if (typeof window.isCustomerLoggedIn === 'undefined') {
            window.isCustomerLoggedIn = function() {
                const customerToken = localStorage.getItem('customerToken');
                const customerUser = localStorage.getItem('customerUser');
                return !!(customerToken && customerUser);
            };
            console.log('‚úÖ isCustomerLoggedIn function added directly to test page');
        }
        
        if (typeof window.loadCartFromBackend === 'undefined') {
            window.loadCartFromBackend = async function() {
                console.log('üîÑ loadCartFromBackend called (fallback version)');
                
                // Try to load from localStorage as fallback
                if (window.isCustomerLoggedIn && window.isCustomerLoggedIn()) {
                    const userCart = window.loadUserCart();
                    console.log('üì¶ Loaded user cart from localStorage fallback:', userCart.length, 'items');
                    return { success: true, cart: { items: userCart || [] } };
                } else {
                    const guestCart = window.loadGuestCart();
                    console.log('üì¶ Loaded guest cart from localStorage fallback:', guestCart.length, 'items');
                    return { success: true, cart: { items: guestCart || [] } };
                }
            };
            console.log('‚úÖ loadCartFromBackend function added directly to test page');
        }
        
        // Function to check if all scripts are loaded
        function checkScriptsLoaded() {
            const allLoaded = Object.values(window.scriptsLoaded).every(loaded => loaded);
            if (allLoaded) {
                console.log('‚úÖ All scripts loaded successfully!');
                initializePage();
            }
        }
        
        // Function to initialize page functionality
        function initializePage() {
            console.log('üöÄ Initializing page functionality...');
            
            // Check what's available
            if (window.authSwitcher) {
                console.log('‚úÖ AuthSwitcher available');
                window.scriptsLoaded.authSwitcher = true;
            } else {
                console.log('‚ùå AuthSwitcher not available');
            }
            
            if (window.api) {
                console.log('‚úÖ API service available');
                window.scriptsLoaded.api = true;
            } else {
                console.log('‚ùå API service not available');
            }
            
            if (typeof window.loadCartFromBackend !== 'undefined') {
                console.log('‚úÖ loadCartFromBackend function available');
                window.scriptsLoaded.main = true;
            } else {
                console.log('‚ùå loadCartFromBackend function not available');
            }
            
            // Update display
            updateAuthStatus();
            updateStorageContents();
        }
        
        // Override console.log to capture logs
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function addLog(type, ...args) {
            const logsDiv = document.getElementById('console-logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="text-gray-400">[${new Date().toLocaleTimeString()}]</span> <span class="text-${type === 'error' ? 'red' : type === 'warn' ? 'yellow' : 'green'}-400">${type.toUpperCase()}:</span> ${args.join(' ')}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        console.log = (...args) => {
            originalLog(...args);
            addLog('log', ...args);
        };
        
        console.warn = (...args) => {
            originalWarn(...args);
            addLog('warn', ...args);
        };
        
        console.error = (...args) => {
            originalError(...args);
            addLog('error', ...args);
        };

        function updateAuthStatus() {
            const statusDiv = document.getElementById('auth-status');
            const currentStatus = window.authSwitcher ? window.authSwitcher.getCurrentStatus() : 'unknown';
            
            let statusClass = 'status-none';
            let statusText = 'No Authentication';
            
            if (currentStatus === 'admin') {
                statusClass = 'status-admin';
                statusText = 'üîê Admin Authenticated';
            } else if (currentStatus === 'customer') {
                statusClass = 'status-customer';
                statusText = 'üë§ Customer Authenticated';
            }
            
            statusDiv.className = `text-lg p-3 rounded ${statusClass}`;
            statusDiv.textContent = statusText;
        }

        function updateStorageContents() {
            const storageDiv = document.getElementById('storage-contents');
            const relevantKeys = [
                'token', 'user', 'customerToken', 'customerUser',
                'tempAdminToken', 'tempAdminUser', 'tempCustomerToken', 'tempCustomerUser'
            ];
            
            let html = '';
            relevantKeys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    try {
                        const parsed = JSON.parse(value);
                        html += `<div class="mb-2"><strong>${key}:</strong> <span class="text-green-600">‚úì Found</span> (${typeof parsed === 'object' ? 'Object' : typeof parsed})</div>`;
                    } catch {
                        html += `<div class="mb-2"><strong>${key}:</strong> <span class="text-green-600">‚úì Found</span> (String)</div>`;
                    }
                } else {
                    html += `<div class="mb-2"><strong>${key}:</strong> <span class="text-red-600">‚úó Not Found</span></div>`;
                }
            });
            
            storageDiv.innerHTML = html;
        }

        function debugAuthState() {
            if (window.authSwitcher) {
                window.authSwitcher.debugAuthState();
            } else {
                console.log('‚ùå AuthSwitcher not available');
            }
        }

        function clearAllAuth() {
            if (window.authSwitcher) {
                window.authSwitcher.clearAllContexts();
                console.log('‚úÖ All authentication contexts cleared');
            } else {
                localStorage.clear();
                console.log('‚úÖ All localStorage cleared');
            }
            updateAuthStatus();
            updateStorageContents();
        }

        function testContextSwitch() {
            if (window.authSwitcher) {
                const currentStatus = window.authSwitcher.getCurrentStatus();
                console.log(`üîÑ Testing context switch from ${currentStatus}`);
                
                if (currentStatus === 'admin') {
                    window.authSwitcher.switchToCustomer();
                } else if (currentStatus === 'customer') {
                    window.authSwitcher.switchToAdmin();
                } else {
                    console.log('‚ö†Ô∏è No context to switch from');
                }
                
                setTimeout(() => {
                    updateAuthStatus();
                    updateStorageContents();
                }, 100);
            }
        }

        function runAuthFix() {
            console.log('üîß Running authentication fix...');
            
            // Check current authentication state
            const currentStatus = window.authSwitcher ? window.authSwitcher.getCurrentStatus() : 'unknown';
            console.log('üîç Current auth status:', currentStatus);
            
            // Check localStorage contents
            const relevantKeys = ['token', 'customerToken', 'user', 'customerUser'];
            console.log('üì¶ Checking localStorage...');
            relevantKeys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    try {
                        const parsed = JSON.parse(value);
                        console.log(`‚úÖ ${key}:`, typeof parsed === 'object' ? 'Object' : 'String', parsed);
                    } catch {
                        console.log(`‚úÖ ${key}: String`, value);
                    }
                } else {
                    console.log(`‚ùå ${key}: Not found`);
                }
            });
            
            // Try to fix authentication issues
            if (currentStatus === 'customer') {
                console.log('üîß Attempting to fix customer authentication...');
                
                // Check if customer token exists and is valid
                const customerToken = localStorage.getItem('customerToken');
                if (customerToken) {
                    try {
                        // Decode JWT token to check expiration
                        const payload = JSON.parse(atob(customerToken.split('.')[1]));
                        const now = Date.now() / 1000;
                        
                        if (payload.exp && payload.exp < now) {
                            console.log('‚ö†Ô∏è Customer token expired, clearing...');
                            localStorage.removeItem('customerToken');
                            localStorage.removeItem('customerUser');
                            alert('Customer token expired. Please login again.');
                        } else {
                            console.log('‚úÖ Customer token is valid, expiring at:', new Date(payload.exp * 1000));
                        }
                    } catch (error) {
                        console.log('‚ùå Error decoding customer token:', error);
                    }
                } else {
                    console.log('‚ùå No customer token found');
                }
            } else if (currentStatus === 'admin') {
                console.log('üîß Attempting to fix admin authentication...');
                
                // Check if admin token exists and is valid
                const adminToken = localStorage.getItem('token');
                if (adminToken) {
                    try {
                        // Decode JWT token to check expiration
                        const payload = JSON.parse(atob(adminToken.split('.')[1]));
                        const now = Date.now() / 1000;
                        
                        if (payload.exp && payload.exp < now) {
                            console.log('‚ö†Ô∏è Admin token expired, clearing...');
                            localStorage.removeItem('token');
                            localStorage.removeItem('user');
                            alert('Admin token expired. Please login again.');
                        } else {
                            console.log('‚úÖ Admin token is valid, expiring at:', new Date(payload.exp * 1000));
                        }
                    } catch (error) {
                        console.log('‚ùå Error decoding admin token:', error);
                    }
                } else {
                    console.log('‚ùå No admin token found');
                }
            } else {
                console.log('‚ö†Ô∏è No authentication context found');
            }
            
            // Test cart loading
            console.log('üõí Testing cart loading...');
            if (typeof loadCartFromBackend === 'function') {
                loadCartFromBackend().then(() => {
                    console.log('‚úÖ Cart loading test completed');
                }).catch(error => {
                    console.error('‚ùå Cart loading test failed:', error);
                });
            } else {
                console.log('‚ùå loadCartFromBackend function not available');
            }
            
            // Update display
            setTimeout(() => {
                updateAuthStatus();
                updateStorageContents();
            }, 1000);
        }

        function runComprehensiveFix() {
            console.log('üöÄ Running comprehensive authentication and cart fix...');
            
            // Run the comprehensive fix script
            if (typeof window.runComprehensiveFixScript === 'function') {
                window.runComprehensiveFixScript();
            } else {
                console.log('üîß Comprehensive fix script not available, running individual fixes...');
                
                // Run individual fixes
                runAuthFix();
                testCartLoading();
                
                // Clear any invalid tokens
                const adminToken = localStorage.getItem('token');
                const customerToken = localStorage.getItem('customerToken');
                
                if (adminToken) {
                    try {
                        const payload = JSON.parse(atob(adminToken.split('.')[1]));
                        const now = Date.now() / 1000;
                        if (payload.exp && payload.exp < now) {
                            console.log('‚ö†Ô∏è Admin token expired, clearing...');
                            localStorage.removeItem('token');
                            localStorage.removeItem('user');
                        }
                    } catch (error) {
                        console.log('‚ùå Invalid admin token, clearing...');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                    }
                }
                
                if (customerToken) {
                    try {
                        const payload = JSON.parse(atob(customerToken.split('.')[1]));
                        const now = Date.now() / 1000;
                        if (payload.exp && payload.exp < now) {
                            console.log('‚ö†Ô∏è Customer token expired, clearing...');
                            localStorage.removeItem('customerToken');
                            localStorage.removeItem('customerUser');
                        }
                    } catch (error) {
                        console.log('‚ùå Invalid customer token, clearing...');
                        localStorage.removeItem('customerToken');
                        localStorage.removeItem('customerUser');
                    }
                }
                
                // Refresh authentication state
                if (window.authSwitcher && typeof window.authSwitcher.refreshAuthState === 'function') {
                    window.authSwitcher.refreshAuthState();
                }
            }
            
            // Update display
            setTimeout(() => {
                updateAuthStatus();
                updateStorageContents();
            }, 1000);
        }

        function testCartLoading() {
            console.log('üõí Testing cart loading functionality...');
            
            // Check if main.js functions are available
            if (typeof loadCartFromBackend === 'function') {
                console.log('‚úÖ loadCartFromBackend function found');
                
                // Test cart loading
                loadCartFromBackend().then(() => {
                    console.log('‚úÖ Cart loading test completed successfully');
                }).catch(error => {
                    console.error('‚ùå Cart loading test failed:', error);
                });
            } else {
                console.log('‚ùå loadCartFromBackend function not available');
                
                // Try to load from localStorage directly
                console.log('üîÑ Attempting to load cart from localStorage...');
                const userCart = localStorage.getItem('userCart');
                const guestCart = localStorage.getItem('guestCart');
                
                if (userCart) {
                    try {
                        const parsed = JSON.parse(userCart);
                        console.log('üì¶ User cart from localStorage:', parsed.length, 'items');
                    } catch (error) {
                        console.error('‚ùå Error parsing user cart:', error);
                    }
                }
                
                if (guestCart) {
                    try {
                        const parsed = JSON.parse(guestCart);
                        console.log('üì¶ Guest cart from localStorage:', parsed.length, 'items');
                    } catch (error) {
                        console.error('‚ùå Error parsing guest cart:', error);
                    }
                }
            }
            
            // Test API service if available
            if (window.api && typeof window.api.getCart === 'function') {
                console.log('‚úÖ API service available, testing getCart...');
                window.api.getCart().then(response => {
                    console.log('‚úÖ API getCart response:', response);
                }).catch(error => {
                    console.error('‚ùå API getCart error:', error);
                });
            } else {
                console.log('‚ùå API service not available');
            }
        }

        function refreshPage() {
            window.location.reload();
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîç Auth Debug Page Loaded');
            
            // Wait a bit for scripts to load
            setTimeout(() => {
                checkScriptsLoaded();
            }, 1000);
            
            // Update every 2 seconds
            setInterval(() => {
                updateAuthStatus();
                updateStorageContents();
            }, 2000);
        });
        
        // Monitor script loading
        window.addEventListener('load', () => {
            console.log('üìú Window loaded, checking scripts...');
            setTimeout(() => {
                checkScriptsLoaded();
            }, 500);
        });
    </script>
</body>
</html>
