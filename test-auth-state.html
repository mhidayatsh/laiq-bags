<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Debug Tool - Laiq Bags</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/api.js"></script>
    <script src="test-auth-switching.js"></script>
    <style>
        .status-success { color: #10b981; }
        .status-error { color: #ef4444; }
        .status-warning { color: #f59e0b; }
        .status-info { color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">
                🔍 Authentication Debug Tool
            </h1>
            
            <!-- Current State -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Current Authentication State</h2>
                <div id="auth-state" class="space-y-3">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                        <span class="font-medium">Admin Token:</span>
                        <span id="admin-token-status" class="status-info">Checking...</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                        <span class="font-medium">Admin User:</span>
                        <span id="admin-user-status" class="status-info">Checking...</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                        <span class="font-medium">Customer Token:</span>
                        <span id="customer-token-status" class="status-info">Checking...</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                        <span class="font-medium">Customer User:</span>
                        <span id="customer-user-status" class="status-info">Checking...</span>
                    </div>
                </div>
                <div id="user-details" class="mt-4 p-4 bg-blue-50 rounded-lg hidden">
                    <h3 class="font-semibold text-blue-800 mb-2">User Details</h3>
                    <div id="user-details-content" class="text-sm text-blue-700"></div>
        </div>
        </div>
        
            <!-- Actions -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Actions</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <button onclick="refreshAuthState()" 
                            class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        🔄 Refresh State
                </button>
                    <button onclick="clearAllAuth()" 
                            class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                    🧹 Clear All Auth
                </button>
                    <button onclick="switchToAdmin()" 
                            class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                        👑 Switch to Admin
                </button>
                    <button onclick="switchToCustomer()" 
                            class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors">
                        👤 Switch to Customer
                </button>
            </div>
        </div>
        
            <!-- API Tests -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">API Tests</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <button onclick="testDashboard()" 
                            class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition-colors">
                        📊 Test Dashboard
                    </button>
                    <button onclick="testOrders()" 
                            class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-colors">
                        📦 Test Orders
                    </button>
                </div>
                <div id="api-results" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
                    <h3 class="font-semibold text-gray-800 mb-2">API Test Results</h3>
                    <div id="api-results-content" class="text-sm text-gray-700"></div>
                </div>
            </div>
            
            <!-- Quick Links -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Quick Links</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <a href="/admin-login.html" 
                       class="bg-gold text-white px-4 py-2 rounded-lg hover:bg-charcoal transition-colors text-center">
                        🔐 Admin Login
                    </a>
                    <a href="/customer-login.html" 
                       class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors text-center">
                        👤 Customer Login
                    </a>
                    <a href="/enhanced-order-management.html" 
                       class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-center">
                        📋 Enhanced Orders
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced functions for the UI
        function refreshAuthState() {
            const adminToken = localStorage.getItem('token');
            const adminUser = localStorage.getItem('user');
                const customerToken = localStorage.getItem('customerToken');
                const customerUser = localStorage.getItem('customerUser');
            
            // Update status indicators
            document.getElementById('admin-token-status').textContent = adminToken ? '✅ Present' : '❌ Missing';
            document.getElementById('admin-token-status').className = adminToken ? 'status-success' : 'status-error';
            
            document.getElementById('admin-user-status').textContent = adminUser ? '✅ Present' : '❌ Missing';
            document.getElementById('admin-user-status').className = adminUser ? 'status-success' : 'status-error';
            
            document.getElementById('customer-token-status').textContent = customerToken ? '✅ Present' : '❌ Missing';
            document.getElementById('customer-token-status').className = customerToken ? 'status-success' : 'status-error';
            
            document.getElementById('customer-user-status').textContent = customerUser ? '✅ Present' : '❌ Missing';
            document.getElementById('customer-user-status').className = customerUser ? 'status-success' : 'status-error';
            
            // Show user details if available
            const userDetailsDiv = document.getElementById('user-details');
            const userDetailsContent = document.getElementById('user-details-content');
            
            if (adminUser || customerUser) {
                userDetailsDiv.classList.remove('hidden');
                let details = '';
                
                if (adminUser) {
                    try {
                        const userData = JSON.parse(adminUser);
                        details += `<div class="mb-2"><strong>Admin:</strong> ${userData.email || 'N/A'} (${userData.role || 'N/A'})</div>`;
                    } catch (error) {
                        details += `<div class="mb-2"><strong>Admin:</strong> Error parsing data</div>`;
                    }
                }
                
                if (customerUser) {
                    try {
                        const userData = JSON.parse(customerUser);
                        details += `<div><strong>Customer:</strong> ${userData.email || 'N/A'} (${userData.role || 'N/A'})</div>`;
                    } catch (error) {
                        details += `<div><strong>Customer:</strong> Error parsing data</div>`;
                    }
                }
                
                userDetailsContent.innerHTML = details;
            } else {
                userDetailsDiv.classList.add('hidden');
            }
        }
        
        async function testDashboard() {
            const resultsDiv = document.getElementById('api-results');
            const resultsContent = document.getElementById('api-results-content');
            
            resultsDiv.classList.remove('hidden');
            resultsContent.innerHTML = '<div class="text-blue-600">Testing dashboard API...</div>';
            
            try {
                const response = await api.getAdminDashboard();
                if (response.success) {
                    resultsContent.innerHTML = `
                        <div class="text-green-600 mb-2">✅ Dashboard API Success</div>
                        <div class="text-sm">
                            <div>Total Orders: ${response.data.totalOrders || 0}</div>
                            <div>Total Revenue: ₹${(response.data.totalRevenue || 0).toLocaleString()}</div>
                            <div>Total Products: ${response.data.totalProducts || 0}</div>
                            <div>Total Customers: ${response.data.totalCustomers || 0}</div>
                        </div>
                    `;
                } else {
                    resultsContent.innerHTML = `<div class="text-red-600">❌ Dashboard API Failed: ${response.message}</div>`;
                        }
                    } catch (error) {
                resultsContent.innerHTML = `<div class="text-red-600">❌ Dashboard API Error: ${error.message}</div>`;
            }
        }
        
        async function testOrders() {
            const resultsDiv = document.getElementById('api-results');
            const resultsContent = document.getElementById('api-results-content');
            
            resultsDiv.classList.remove('hidden');
            resultsContent.innerHTML = '<div class="text-blue-600">Testing orders API...</div>';
            
            try {
                const response = await api.getAdminOrders('?page=1&limit=5');
                if (response.success) {
                    resultsContent.innerHTML = `
                        <div class="text-green-600 mb-2">✅ Orders API Success</div>
                        <div class="text-sm">
                            <div>Orders Count: ${response.orders?.length || 0}</div>
                            <div>Total Pages: ${response.totalPages || 1}</div>
                            <div>Current Page: ${response.currentPage || 1}</div>
                        </div>
                    `;
            } else {
                    resultsContent.innerHTML = `<div class="text-red-600">❌ Orders API Failed: ${response.message}</div>`;
                }
                    } catch (error) {
                resultsContent.innerHTML = `<div class="text-red-600">❌ Orders API Error: ${error.message}</div>`;
            }
        }
        
        // Override the original functions to update UI
        const originalClearAllAuth = window.clearAllAuth;
        window.clearAllAuth = function() {
            originalClearAllAuth();
            refreshAuthState();
        };
        
        const originalSwitchToAdmin = window.switchToAdmin;
        window.switchToAdmin = function() {
            const result = originalSwitchToAdmin();
            refreshAuthState();
            return result;
        };
        
        const originalSwitchToCustomer = window.switchToCustomer;
        window.switchToCustomer = function() {
            const result = originalSwitchToCustomer();
            refreshAuthState();
            return result;
        };
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            refreshAuthState();
        });
    </script>
</body>
</html>
